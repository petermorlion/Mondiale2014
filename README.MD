Disclaimer: this was hacked together very quickyl to meet a deadline. It is not an example of the code I normally would write :)